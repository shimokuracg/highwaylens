<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HighwayLens - é«˜é€Ÿé“è·¯ã‚¤ãƒ³ãƒ•ãƒ©ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'Meiryo', sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .logo { font-size: 22px; font-weight: 700; }
        .logo span { color: #4ade80; }
        .header-info {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.15);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
        }
        .header-info-icon { font-size: 16px; }
        .lang-toggle {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            padding: 6px 12px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .lang-toggle:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            height: calc(100vh - 64px);
        }

        /* Sidebar */
        .sidebar {
            background: white;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* Summary Cards */
        .summary-section {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        .summary-title {
            font-size: 13px;
            font-weight: 600;
            color: #666;
            margin-bottom: 12px;
        }
        .summary-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .summary-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }
        .summary-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .summary-card.danger { border-color: #ef4444; background: #fef2f2; }
        .summary-card.warning { border-color: #f97316; background: #fff7ed; }
        .summary-card.caution { border-color: #eab308; background: #fefce8; }
        .summary-card.safe { border-color: #22c55e; background: #f0fdf4; }
        .summary-count { font-size: 36px; font-weight: 700; line-height: 1; }
        .summary-card.danger .summary-count { color: #dc2626; }
        .summary-card.warning .summary-count { color: #ea580c; }
        .summary-card.caution .summary-count { color: #ca8a04; }
        .summary-card.safe .summary-count { color: #16a34a; }
        .summary-label { font-size: 12px; color: #666; margin-top: 6px; font-weight: 500; }
        .summary-action {
            font-size: 10px;
            margin-top: 8px;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(0,0,0,0.05);
        }

        /* Alert List */
        .alert-section {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .alert-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        .alert-count {
            background: #ef4444;
            color: white;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .route-filter {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
        }
        .route-filter-btn {
            flex: 1;
            padding: 7px 0;
            border: 1.5px solid #d1d5db;
            border-radius: 8px;
            background: white;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .route-filter-btn:hover { background: #f3f4f6; }
        .route-filter-btn.active {
            border-color: #3b82f6;
            background: #eff6ff;
            color: #2563eb;
        }
        .route-filter-btn.active.shintomei {
            border-color: #8b5cf6;
            background: #f5f3ff;
            color: #7c3aed;
        }
        .alert-list { display: flex; flex-direction: column; gap: 10px; }
        .alert-item {
            background: white;
            border-radius: 12px;
            padding: 14px;
            border-left: 4px solid;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.2s;
        }
        .alert-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        .alert-item.danger { border-color: #ef4444; background: #fef2f2; }
        .alert-item.warning { border-color: #f97316; background: #fff7ed; }
        .alert-item.caution { border-color: #eab308; background: #fefce8; }
        .alert-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .alert-location {
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }
        .alert-badge {
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }
        .alert-item.danger .alert-badge { background: #fee2e2; color: #dc2626; }
        .alert-item.warning .alert-badge { background: #ffedd5; color: #ea580c; }
        .alert-item.caution .alert-badge { background: #fef9c3; color: #ca8a04; }
        .alert-status {
            font-size: 13px;
            color: #555;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .alert-action {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #2563eb;
            font-weight: 500;
        }
        .alert-action-icon { font-size: 14px; }

        .no-alerts {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }
        .no-alerts-icon { font-size: 48px; margin-bottom: 12px; }
        .no-alerts-text { font-size: 14px; }

        /* Footer */
        .sidebar-footer {
            padding: 16px 20px;
            border-top: 1px solid #eee;
            background: #f8f9fa;
        }
        .data-info {
            font-size: 11px;
            color: #888;
            line-height: 1.6;
        }
        .update-time {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }

        /* Map Container */
        .map-container {
            position: relative;
            overflow: visible;
        }
        #map {
            width: 100%;
            height: 100%;
            /* Ensure bottom controls are not clipped */
        }

        /* Leaflet control adjustments */
        .leaflet-control-zoom {
            border: none !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
            margin: 10px !important;
        }
        .leaflet-control-zoom a {
            width: 32px !important;
            height: 32px !important;
            line-height: 32px !important;
            font-size: 16px !important;
        }
        .leaflet-control-layers {
            border: none !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
            border-radius: 8px !important;
            margin: 10px !important;
        }
        .leaflet-control-scale {
            margin: 10px !important;
        }
        .leaflet-control-attribution {
            background: rgba(255,255,255,0.9) !important;
            padding: 4px 10px !important;
            font-size: 10px !important;
            margin-bottom: 15px !important;
            margin-right: 10px !important;
            border-radius: 4px !important;
            line-height: 1.4 !important;
        }

        /* Map Controls */
        .map-controls {
            position: absolute;
            top: 80px;
            right: 10px;
            z-index: 1000;
        }
        .map-btn {
            background: white;
            border: none;
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 12px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .map-btn:hover { background: #f0f0f0; }
        .map-btn.active { background: #e0f2fe; color: #0369a1; }

        /* Legend */
        .map-legend {
            position: absolute;
            bottom: 50px;
            left: 10px;
            z-index: 999;
            background: white;
            border-radius: 8px;
            padding: 10px 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            font-size: 11px;
        }
        .legend-title {
            font-size: 11px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
            font-size: 11px;
            color: #444;
        }
        .legend-item:last-child { margin-bottom: 0; }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }
        .legend-dot.danger { background: #ef4444; }
        .legend-dot.warning { background: #f97316; }
        .legend-dot.caution { background: #eab308; }
        .legend-dot.safe { background: #22c55e; }
        .legend-dot.unknown { background: #9ca3af; }

        /* Popup Styles */
        .leaflet-popup-content-wrapper {
            border-radius: 12px !important;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15) !important;
        }
        .leaflet-popup-content {
            margin: 12px 14px !important;
            font-family: 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'Meiryo', sans-serif !important;
        }
        .popup-content {
            min-width: 260px;
            max-width: 320px;
        }
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        .popup-title {
            font-size: 15px;
            font-weight: 700;
            color: #333;
        }
        .popup-score {
            padding: 3px 10px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 12px;
        }
        .popup-score.danger { background: #fee2e2; color: #dc2626; }
        .popup-score.warning { background: #ffedd5; color: #ea580c; }
        .popup-score.caution { background: #fef9c3; color: #ca8a04; }
        .popup-score.safe { background: #dcfce7; color: #16a34a; }
        .popup-score.unknown { background: #f3f4f6; color: #6b7280; }
        .popup-status {
            font-size: 13px;
            color: #333;
            margin-bottom: 10px;
            padding: 8px 10px;
            background: #f8f9fa;
            border-radius: 6px;
            line-height: 1.4;
        }
        .popup-details {
            font-size: 11px;
            color: #666;
        }
        .popup-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
        }
        .popup-insights {
            margin-top: 10px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        .popup-insights-title {
            font-size: 11px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }
        .insight-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 6px 8px;
            margin-bottom: 4px;
            border-radius: 6px;
            background: #f8f9fa;
        }
        .insight-item:last-child { margin-bottom: 0; }
        .insight-item.high { background: #fef2f2; }
        .insight-item.medium { background: #fffbeb; }
        .insight-item.low { background: #f0fdf4; }
        .insight-icon { font-size: 16px; line-height: 1; }
        .insight-content { flex: 1; min-width: 0; }
        .insight-label { font-size: 9px; color: #888; text-transform: uppercase; }
        .insight-value { font-size: 12px; font-weight: 500; color: #333; line-height: 1.3; }
        .insight-detail { font-size: 10px; color: #666; margin-top: 1px; }

        /* Loading State */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #888;
        }
        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #e0e0e0;
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 12px; font-size: 13px; }

        /* ====== Agent Toggle (Header) ====== */
        .agent-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.25);
            border-radius: 8px;
            padding: 6px 14px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .agent-toggle:hover { background: rgba(255,255,255,0.25); }
        .agent-toggle.active {
            background: rgba(74,222,128,0.25);
            border-color: rgba(74,222,128,0.5);
        }

        /* ====== Chat Panel ====== */

        .chat-panel {
            position: fixed;
            top: 0;
            right: -420px;
            width: 400px;
            height: 100vh;
            background: white;
            z-index: 1200;
            display: flex;
            flex-direction: column;
            box-shadow: -4px 0 24px rgba(0,0,0,0.15);
            transition: right 0.3s ease;
        }
        .chat-panel.open { right: 0; }

        .chat-panel-header {
            background: linear-gradient(135deg, #1e3a5f, #2d5a87);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-panel-title { font-size: 16px; font-weight: 600; }
        .chat-model-switch {
            display: flex;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            padding: 2px;
        }
        .chat-model-btn {
            background: none;
            border: none;
            color: rgba(255,255,255,0.6);
            font-size: 11px;
            font-weight: 600;
            padding: 3px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .chat-model-btn:hover { color: white; }
        .chat-model-btn.active {
            background: rgba(255,255,255,0.25);
            color: white;
        }

        .chat-close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-suggest {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 20px 0;
        }
        .chat-suggest-btn {
            background: #f0f4ff;
            border: 1px solid #c7d2fe;
            border-radius: 10px;
            padding: 10px 14px;
            font-size: 13px;
            color: #4338ca;
            cursor: pointer;
            text-align: left;
            transition: background 0.2s;
        }
        .chat-suggest-btn:hover { background: #e0e7ff; }

        .chat-msg {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 13px;
            line-height: 1.6;
            word-break: break-word;
        }
        .chat-msg.user {
            align-self: flex-end;
            background: #2563eb;
            color: white;
            border-bottom-right-radius: 4px;
        }
        .chat-msg.assistant {
            align-self: flex-start;
            background: #f3f4f6;
            color: #333;
            border-bottom-left-radius: 4px;
        }
        .chat-msg.assistant .seg-link {
            color: #2563eb;
            cursor: pointer;
            text-decoration: underline;
            font-weight: 600;
        }
        .chat-msg.assistant .seg-link:hover { color: #1d4ed8; }
        .chat-msg.thinking {
            align-self: flex-start;
            background: #f3f4f6;
            color: #888;
            font-style: italic;
        }
        .chat-typing-dots { display: inline-flex; gap: 4px; align-items: center; height: 20px; }
        .chat-typing-dots span {
            width: 6px; height: 6px; border-radius: 50%; background: #999;
            animation: chatBounce 1.4s ease-in-out infinite;
        }
        .chat-typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .chat-typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes chatBounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-6px); }
        }
        .chat-msg.appear {
            animation: chatFadeIn 0.25s ease-out;
        }
        @keyframes chatFadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-input-area {
            border-top: 1px solid #eee;
            padding: 12px 16px;
            display: flex;
            gap: 8px;
        }
        .chat-input {
            flex: 1;
            border: 1.5px solid #d1d5db;
            border-radius: 10px;
            padding: 10px 14px;
            font-size: 13px;
            outline: none;
            font-family: inherit;
            resize: none;
            min-height: 40px;
            max-height: 100px;
        }
        .chat-input:focus { border-color: #2563eb; }
        .chat-send-btn {
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 0 16px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .chat-send-btn:hover { background: #1d4ed8; }
        .chat-send-btn:disabled { background: #93c5fd; cursor: not-allowed; }

        /* ====== Popup Comment & Inspection Sections ====== */
        .popup-actions-bar {
            display: flex;
            gap: 6px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        .popup-action-btn {
            flex: 1;
            padding: 6px 0;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            font-size: 11px;
            cursor: pointer;
            text-align: center;
            transition: background 0.2s;
        }
        .popup-action-btn:hover { background: #f3f4f6; }

        /* ====== Popup Inspection History ====== */
        .popup-inspections-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        .popup-inspections-title { font-size: 11px; font-weight: 600; color: #666; margin-bottom: 6px; }
        .popup-inspection-item {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 6px 8px;
            margin-bottom: 4px;
            font-size: 11px;
            border-left: 3px solid #ccc;
        }
        .popup-inspection-item.cond-good { border-left-color: #22c55e; }
        .popup-inspection-item.cond-fair { border-left-color: #3b82f6; }
        .popup-inspection-item.cond-poor { border-left-color: #f97316; }
        .popup-inspection-item.cond-critical { border-left-color: #ef4444; }
        .popup-inspection-meta { color: #888; font-size: 10px; }
        .popup-inspection-findings { color: #333; margin-top: 2px; }
        .popup-inspection-badge {
            display: inline-block;
            font-size: 10px;
            padding: 1px 6px;
            border-radius: 4px;
            font-weight: 600;
            color: white;
        }
        .popup-inspection-badge.good { background: #22c55e; }
        .popup-inspection-badge.fair { background: #3b82f6; }
        .popup-inspection-badge.poor { background: #f97316; }
        .popup-inspection-badge.critical { background: #ef4444; }

        /* ====== Sidebar Tabs ====== */
        .sidebar-tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 12px;
        }
        .sidebar-tab {
            flex: 1;
            padding: 8px 0;
            border: none;
            background: none;
            font-size: 13px;
            font-weight: 600;
            color: #888;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
            text-align: center;
        }
        .sidebar-tab:hover { color: #555; }
        .sidebar-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
        .sidebar-inspection-item {
            background: white;
            border-radius: 12px;
            padding: 14px;
            border-left: 4px solid #ccc;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 10px;
        }
        .sidebar-inspection-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        .sidebar-inspection-item.cond-good { border-color: #22c55e; }
        .sidebar-inspection-item.cond-fair { border-color: #3b82f6; }
        .sidebar-inspection-item.cond-poor { border-color: #f97316; }
        .sidebar-inspection-item.cond-critical { border-color: #ef4444; }
        .sidebar-inspection-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        .sidebar-inspection-location { font-weight: 600; font-size: 13px; }
        .sidebar-inspection-badge {
            display: inline-block;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 6px;
            font-weight: 600;
            color: white;
        }
        .sidebar-inspection-badge.good { background: #22c55e; }
        .sidebar-inspection-badge.fair { background: #3b82f6; }
        .sidebar-inspection-badge.poor { background: #f97316; }
        .sidebar-inspection-badge.critical { background: #ef4444; }
        .sidebar-inspection-meta { font-size: 12px; color: #666; margin-bottom: 4px; }
        .sidebar-inspection-findings { font-size: 12px; color: #333; }

        /* ====== Inspection Modal ====== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.open { display: flex; }
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            width: 420px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; }
        .modal-field { margin-bottom: 12px; }
        .modal-label { font-size: 12px; font-weight: 600; color: #555; display: block; margin-bottom: 4px; }
        .modal-input, .modal-select, .modal-textarea {
            width: 100%;
            border: 1.5px solid #d1d5db;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 13px;
            font-family: inherit;
            outline: none;
        }
        .modal-input:focus, .modal-select:focus, .modal-textarea:focus { border-color: #2563eb; }
        .modal-textarea { resize: vertical; min-height: 60px; }
        .modal-buttons { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }
        .modal-btn {
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }
        .modal-btn.primary { background: #2563eb; color: white; }
        .modal-btn.secondary { background: #f3f4f6; color: #333; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div class="logo">Highway<span>Lens</span></div>
        </div>
        <div class="header-right">
            <div class="header-info">
                <span class="header-info-icon">ğŸ“¡</span>
                <span id="observation-date">è¡›æ˜Ÿè¦³æ¸¬æ—¥: 2026å¹´1æœˆ26æ—¥ã€œ2æœˆ7æ—¥</span>
            </div>
            <button class="agent-toggle" id="agent-toggle" onclick="toggleChatPanel()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="12" rx="3"/>
                    <circle cx="9" cy="10" r="1.5" fill="currentColor" stroke="none"/>
                    <circle cx="15" cy="10" r="1.5" fill="currentColor" stroke="none"/>
                    <path d="M8 20l4-4 4 4"/>
                </svg>
                <span id="agent-label">AI Agent</span>
            </button>
            <button class="lang-toggle" id="lang-toggle" onclick="toggleLanguage()">
                <span id="lang-label">EN</span>
            </button>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="summary-section">
                <div class="summary-title">ğŸ“Š ç›£è¦–çŠ¶æ³ã‚µãƒãƒªãƒ¼</div>
                <div class="summary-cards">
                    <div class="summary-card danger" onclick="filterByLevel('red')">
                        <div class="summary-count" id="count-danger">-</div>
                        <div class="summary-label">è¦å¯¾å¿œ</div>
                        <div class="summary-action">ç·Šæ€¥ç‚¹æ¤œãŒå¿…è¦</div>
                    </div>
                    <div class="summary-card warning" onclick="filterByLevel('orange')">
                        <div class="summary-count" id="count-warning">-</div>
                        <div class="summary-label">è¦æ³¨æ„</div>
                        <div class="summary-action">ç¾åœ°ç¢ºèªã‚’æ¨å¥¨</div>
                    </div>
                    <div class="summary-card caution" onclick="filterByLevel('yellow')">
                        <div class="summary-count" id="count-caution">-</div>
                        <div class="summary-label">çµŒéè¦³å¯Ÿ</div>
                        <div class="summary-action">ç›£è¦–ç¶™ç¶š</div>
                    </div>
                    <div class="summary-card safe" onclick="filterByLevel('green')">
                        <div class="summary-count" id="count-safe">-</div>
                        <div class="summary-label">ç•°å¸¸ãªã—</div>
                        <div class="summary-action">é€šå¸¸ç›£è¦–</div>
                    </div>
                </div>
            </div>

            <div class="alert-section">
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" id="sidebar-tab-alerts" onclick="switchSidebarTab('alerts')">âš ï¸ å¯¾å¿œç®‡æ‰€</button>
                    <button class="sidebar-tab" id="sidebar-tab-inspections" onclick="switchSidebarTab('inspections')">ğŸ“‹ ç‚¹æ¤œè¨˜éŒ²</button>
                </div>
                <div id="tab-alerts">
                    <div class="alert-header">
                        <div class="alert-title">âš ï¸ å¯¾å¿œãŒå¿…è¦ãªç®‡æ‰€</div>
                        <div class="alert-count" id="alert-count">0</div>
                    </div>
                    <div class="route-filter">
                        <button class="route-filter-btn active" id="filter-all" onclick="setRouteFilter('all')">ã™ã¹ã¦</button>
                        <button class="route-filter-btn" id="filter-tomei" onclick="setRouteFilter('TOMEI')">æ±å</button>
                        <button class="route-filter-btn shintomei" id="filter-shintomei" onclick="setRouteFilter('SHINTOMEI')">æ–°æ±å</button>
                    </div>
                    <div class="alert-list" id="alert-list">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <div class="loading-text" id="loading-text">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                        </div>
                    </div>
                </div>
                <div id="tab-inspections" style="display:none">
                    <div id="sidebar-inspection-list">
                        <div style="text-align:center;color:#999;padding:20px;font-size:13px;">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <div class="data-info">
                    ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: Sentinel-1è¡›æ˜Ÿ (ESA)<br>
                    åœ°å½¢: å›½åœŸåœ°ç†é™¢DEM / æ°—è±¡: æ°—è±¡åº
                </div>
                <div class="update-time" id="update-time">æœ€çµ‚ç¢ºèª: --</div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>

            <div class="map-controls">
            </div>

            <div class="map-legend">
                <div class="legend-title">å‡¡ä¾‹</div>
                <div class="legend-item"><div class="legend-dot danger"></div><span>è¦å¯¾å¿œ</span></div>
                <div class="legend-item"><div class="legend-dot warning"></div><span>è¦æ³¨æ„</span></div>
                <div class="legend-item"><div class="legend-dot caution"></div><span>çµŒéè¦³å¯Ÿ</span></div>
                <div class="legend-item"><div class="legend-dot safe"></div><span>ç•°å¸¸ãªã—</span></div>
                <div class="legend-item"><div class="legend-dot" style="background:#f97316;border:2px dashed #666;width:10px;height:10px;"></div><span>æš«å®šè©•ä¾¡</span></div>
                <div style="border-top: 1px solid #eee; margin: 6px 0 4px;"></div>
                <div class="legend-item"><div style="width:20px;height:3px;background:#3b82f6;border-radius:2px;flex-shrink:0;"></div><span id="legend-tomei">æ±å (E1)</span></div>
                <div class="legend-item"><div style="width:20px;height:3px;background:#8b5cf6;border-radius:2px;flex-shrink:0;"></div><span id="legend-shintomei">æ–°æ±å (E1A)</span></div>
            </div>
        </div>
    </div>

    <!-- Chat FAB removed â€” toggle is in the header -->

    <!-- Chat Slide-out Panel -->
    <div class="chat-panel" id="chat-panel">
        <div class="chat-panel-header">
            <div class="chat-panel-title" id="chat-title">AI Assistant</div>
            <div style="display:flex;align-items:center;gap:8px;">
                <div class="chat-model-switch" id="chat-model-switch">
                    <button class="chat-model-btn active" data-model="fast" onclick="setChatModel('fast')">Flash</button>
                    <button class="chat-model-btn" data-model="pro" onclick="setChatModel('pro')">Pro</button>
                </div>
                <button class="chat-close-btn" onclick="toggleChatPanel()">âœ•</button>
            </div>
        </div>
        <div class="chat-messages" id="chat-messages">
            <div class="chat-suggest" id="chat-suggest">
                <div style="font-size:13px;color:#666;margin-bottom:4px;" id="chat-suggest-label">è³ªå•ã—ã¦ã¿ã¾ã—ã‚‡ã†:</div>
                <button class="chat-suggest-btn" onclick="sendSuggestion(this.textContent)">èµ¤ãƒ¬ãƒ™ãƒ«ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ã¾ã¨ã‚ã¦</button>
                <button class="chat-suggest-btn" onclick="sendSuggestion(this.textContent)">æ–°æ±åã§æœ€ã‚‚ãƒªã‚¹ã‚¯ãŒé«˜ã„ç®‡æ‰€ã¯ï¼Ÿ</button>
                <button class="chat-suggest-btn" onclick="sendSuggestion(this.textContent)">å…¨ä½“ã®ç›£è¦–çŠ¶æ³ã‚’æ•™ãˆã¦</button>
            </div>
        </div>
        <div class="chat-input-area">
            <textarea class="chat-input" id="chat-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey&&!chatBusy){event.preventDefault();sendChatMessage();}"></textarea>
            <button class="chat-send-btn" id="chat-send" onclick="sendChatMessage()">é€ä¿¡</button>
        </div>
    </div>

    <!-- Inspection Modal -->
    <div class="modal-overlay" id="inspection-modal">
        <div class="modal-content">
            <div class="modal-title" id="modal-inspection-title">ç‚¹æ¤œè¨˜éŒ²</div>
            <input type="hidden" id="inspection-segment-id">
            <div class="modal-field">
                <label class="modal-label" id="label-inspector">ç‚¹æ¤œè€…</label>
                <input class="modal-input" id="inspection-inspector" type="text">
            </div>
            <div class="modal-field">
                <label class="modal-label" id="label-date">ç‚¹æ¤œæ—¥</label>
                <input class="modal-input" id="inspection-date" type="date">
            </div>
            <div class="modal-field">
                <label class="modal-label" id="label-weather">å¤©å€™</label>
                <input class="modal-input" id="inspection-weather" type="text">
            </div>
            <div class="modal-field">
                <label class="modal-label" id="label-condition">çŠ¶æ…‹</label>
                <select class="modal-select" id="inspection-condition">
                    <option value="good">è‰¯å¥½ (Good)</option>
                    <option value="fair">æ™®é€š (Fair)</option>
                    <option value="poor">ä¸è‰¯ (Poor)</option>
                    <option value="critical">å±é™º (Critical)</option>
                </select>
            </div>
            <div class="modal-field">
                <label class="modal-label" id="label-findings">æ‰€è¦‹</label>
                <textarea class="modal-textarea" id="inspection-findings"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeInspectionModal()" id="btn-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="modal-btn primary" onclick="submitInspection()" id="btn-submit-inspection">ç™»éŒ²</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // Translations
        // ============================================
        const translations = {
            ja: {
                observationDate: 'è¡›æ˜Ÿè¦³æ¸¬æ—¥: 2026å¹´1æœˆ26æ—¥ã€œ2æœˆ7æ—¥',
                langLabel: 'EN',
                summaryTitle: 'ğŸ“Š ç›£è¦–çŠ¶æ³ã‚µãƒãƒªãƒ¼',
                levelDanger: 'è¦å¯¾å¿œ',
                levelWarning: 'è¦æ³¨æ„',
                levelCaution: 'çµŒéè¦³å¯Ÿ',
                levelSafe: 'ç•°å¸¸ãªã—',
                levelUnknown: 'æš«å®šè©•ä¾¡',
                actionDanger: 'ç·Šæ€¥ç‚¹æ¤œãŒå¿…è¦',
                actionWarning: 'ç¾åœ°ç¢ºèªã‚’æ¨å¥¨',
                actionCaution: 'ç›£è¦–ç¶™ç¶š',
                actionSafe: 'é€šå¸¸ç›£è¦–',
                alertTitle: 'âš ï¸ å¯¾å¿œãŒå¿…è¦ãªç®‡æ‰€',
                filterAll: 'ã™ã¹ã¦',
                filterTomei: 'æ±å',
                filterShintomei: 'æ–°æ±å',
                loading: 'ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...',
                noAlerts: 'ç¾åœ¨ã€å¯¾å¿œãŒå¿…è¦ãªç®‡æ‰€ã¯ã‚ã‚Šã¾ã›ã‚“',
                loadError: 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ',
                dataSource: 'ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: Sentinel-1è¡›æ˜Ÿ (ESA)<br>åœ°å½¢: å›½åœŸåœ°ç†é™¢DEM / æ°—è±¡: æ°—è±¡åº',
                lastUpdate: 'æœ€çµ‚ç¢ºèª',
                legendTitle: 'å‡¡ä¾‹',
                clickToView: 'ã‚¯ãƒªãƒƒã‚¯ã§åœ°å›³è¡¨ç¤º',
                coordinates: 'åº§æ¨™',
                insightsTitle: 'ğŸ“Š è¦³æ¸¬ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®åˆ†æ',
                popupActionDanger: 'ğŸš¨ ç·Šæ€¥ç‚¹æ¤œã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„',
                popupActionWarning: 'ğŸ‘· ç¾åœ°ç¢ºèªã‚’ãŠå‹§ã‚ã—ã¾ã™',
                popupActionCaution: 'ğŸ‘€ çµŒéè¦³å¯Ÿã‚’ç¶™ç¶šã—ã¦ãã ã•ã„',
                popupActionSafe: 'âœ“ é€šå¸¸ç›£è¦–ã‚’ç¶™ç¶š',
                popupActionUnknown: 'ğŸ“¡ InSARãƒ‡ãƒ¼ã‚¿ã‚’è¦³æ¸¬ä¸­ã§ã™',
                chatTitle: 'AI ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ',
                chatPlaceholder: 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...',
                chatSend: 'é€ä¿¡',
                chatSuggestLabel: 'è³ªå•ã—ã¦ã¿ã¾ã—ã‚‡ã†:',
                chatThinking: 'è€ƒãˆä¸­...',
                commentsTitle: 'ã‚³ãƒ¡ãƒ³ãƒˆ',
                addComment: 'è¿½åŠ ',
                commentPlaceholder: 'ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›...',
                inspectionBtn: 'ç‚¹æ¤œè¨˜éŒ²',
                inspectionTitle: 'ç‚¹æ¤œè¨˜éŒ²',
                inspectorLabel: 'ç‚¹æ¤œè€…',
                dateLabel: 'ç‚¹æ¤œæ—¥',
                weatherLabel: 'å¤©å€™',
                conditionLabel: 'çŠ¶æ…‹',
                findingsLabel: 'æ‰€è¦‹',
                cancelBtn: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
                submitBtn: 'ç™»éŒ²',
                noComments: 'ã‚³ãƒ¡ãƒ³ãƒˆãªã—',
                inspectionHistory: 'ç‚¹æ¤œå±¥æ­´',
                noInspections: 'ç‚¹æ¤œè¨˜éŒ²ãªã—',
                alertsTab: 'å¯¾å¿œç®‡æ‰€',
                inspectionTab: 'ç‚¹æ¤œè¨˜éŒ²',
                conditionGood: 'è‰¯å¥½',
                conditionFair: 'æ™®é€š',
                conditionPoor: 'ä¸è‰¯',
                conditionCritical: 'å±é™º'
            },
            en: {
                observationDate: 'Observation: Jan 26 - Feb 7, 2026',
                langLabel: 'JA',
                summaryTitle: 'ğŸ“Š Monitoring Summary',
                levelDanger: 'Critical',
                levelWarning: 'Warning',
                levelCaution: 'Caution',
                levelSafe: 'Normal',
                levelUnknown: 'Provisional',
                actionDanger: 'Urgent inspection required',
                actionWarning: 'On-site check recommended',
                actionCaution: 'Continue monitoring',
                actionSafe: 'Normal monitoring',
                alertTitle: 'âš ï¸ Action Required',
                filterAll: 'All',
                filterTomei: 'Tomei',
                filterShintomei: 'Shin-Tomei',
                loading: 'Loading data...',
                noAlerts: 'No locations require action at this time',
                loadError: 'Failed to load data',
                dataSource: 'Data: Sentinel-1 Satellite (ESA)<br>Terrain: GSI DEM / Weather: JMA',
                lastUpdate: 'Last updated',
                legendTitle: 'Legend',
                clickToView: 'Click to view on map',
                coordinates: 'Coordinates',
                insightsTitle: 'ğŸ“Š Data-Driven Analysis',
                popupActionDanger: 'ğŸš¨ Urgent inspection required',
                popupActionWarning: 'ğŸ‘· On-site check recommended',
                popupActionCaution: 'ğŸ‘€ Continue monitoring',
                popupActionSafe: 'âœ“ Continue normal monitoring',
                popupActionUnknown: 'ğŸ“¡ Collecting InSAR observation data',
                chatTitle: 'AI Assistant',
                chatPlaceholder: 'Type a message...',
                chatSend: 'Send',
                chatSuggestLabel: 'Try asking:',
                chatThinking: 'Thinking...',
                commentsTitle: 'Comments',
                addComment: 'Add',
                commentPlaceholder: 'Add a comment...',
                inspectionBtn: 'Inspection',
                inspectionTitle: 'Inspection Record',
                inspectorLabel: 'Inspector',
                dateLabel: 'Date',
                weatherLabel: 'Weather',
                conditionLabel: 'Condition',
                findingsLabel: 'Findings',
                cancelBtn: 'Cancel',
                submitBtn: 'Submit',
                noComments: 'No comments',
                inspectionHistory: 'Inspection History',
                noInspections: 'No inspections',
                alertsTab: 'Action Required',
                inspectionTab: 'Inspections',
                conditionGood: 'Good',
                conditionFair: 'Fair',
                conditionPoor: 'Poor',
                conditionCritical: 'Critical'
            }
        };

        let currentLang = localStorage.getItem('highwaylens-lang') || 'ja';

        function t(key) {
            return translations[currentLang][key] || key;
        }

        function toggleLanguage() {
            currentLang = currentLang === 'ja' ? 'en' : 'ja';
            localStorage.setItem('highwaylens-lang', currentLang);
            updateUILanguage();
            updateAlertList();
        }

        function updateUILanguage() {
            // Header
            document.getElementById('observation-date').textContent = t('observationDate');
            document.getElementById('lang-label').textContent = t('langLabel');

            // Summary section
            document.querySelector('.summary-title').textContent = t('summaryTitle');
            const cards = document.querySelectorAll('.summary-card');
            const labels = ['levelDanger', 'levelWarning', 'levelCaution', 'levelSafe'];
            const actions = ['actionDanger', 'actionWarning', 'actionCaution', 'actionSafe'];
            cards.forEach((card, i) => {
                card.querySelector('.summary-label').textContent = t(labels[i]);
                card.querySelector('.summary-action').textContent = t(actions[i]);
            });

            // Alert section
            document.querySelector('.alert-title').textContent = t('alertTitle');
            document.getElementById('filter-all').textContent = t('filterAll');
            document.getElementById('filter-tomei').textContent = t('filterTomei');
            document.getElementById('filter-shintomei').textContent = t('filterShintomei');

            // Sidebar footer
            document.querySelector('.data-info').innerHTML = t('dataSource');

            // Legend
            document.querySelector('.legend-title').textContent = t('legendTitle');
            const legendItems = document.querySelectorAll('.legend-item span');
            const legendLabels = ['levelDanger', 'levelWarning', 'levelCaution', 'levelSafe', 'levelUnknown'];
            legendItems.forEach((item, i) => {
                item.textContent = t(legendLabels[i]);
            });

            // Loading text (if visible)
            const loadingText = document.getElementById('loading-text');
            if (loadingText) {
                loadingText.textContent = t('loading');
            }

            // Refresh markers with new language
            if (allSegments.length > 0) {
                refreshMarkers();
            }
        }

        function refreshMarkers() {
            // Close all open popups first
            map.closePopup();
            // Remove all existing markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            // Create new markers with current language
            allSegments.forEach(segment => {
                const marker = createMarker(segment);
                marker.addTo(map);
                markers.push(marker);
            });
        }

        // Initialize map â€” constrained to Honshu (main island of Japan)
        const honshuBounds = L.latLngBounds(
            [33.0, 129.5],  // SW corner (Shimonoseki / western tip)
            [41.5, 142.0]   // NE corner (Aomori / northern tip)
        );
        // Default view: fit to data markers (set after data loads)
        const corridorBounds = L.latLngBounds(
            [34.55, 137.30],
            [35.55, 139.55]
        );
        const map = L.map('map', {
            maxBounds: honshuBounds.pad(0.1),
            maxBoundsViscosity: 0.8,
            minZoom: 5,
            maxZoom: 18,
        }).fitBounds(corridorBounds);

        // Base layers
        const baseLayers = {
            'Satellite': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '&copy; Esri',
                maxZoom: 18,
            }),
            'Street': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap',
                maxZoom: 18,
            })
        };
        baseLayers['Satellite'].addTo(map);
        L.control.layers(baseLayers, null, { position: 'topright' }).addTo(map);
        L.control.scale({ imperial: false, position: 'bottomleft' }).addTo(map);

        let markers = [];
        let allSegments = [];
        let routeLayers = [];
        let currentRouteFilter = 'all';

        function setRouteFilter(filter) {
            currentRouteFilter = filter;
            document.querySelectorAll('.route-filter-btn').forEach(btn => btn.classList.remove('active'));
            if (filter === 'all') document.getElementById('filter-all').classList.add('active');
            else if (filter === 'TOMEI') document.getElementById('filter-tomei').classList.add('active');
            else if (filter === 'SHINTOMEI') document.getElementById('filter-shintomei').classList.add('active');

            // Filter map markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            const filtered = filter === 'all'
                ? allSegments
                : allSegments.filter(s => s.segment_id.startsWith(filter));
            filtered.forEach(segment => {
                const marker = createMarker(segment);
                marker.addTo(map);
                markers.push(marker);
            });

            // Filter route lines
            routeLayers.forEach(layer => {
                if (filter === 'all') {
                    layer.addTo(map);
                } else {
                    const match = (filter === 'TOMEI' && layer._routeKey === 'tomei') ||
                                  (filter === 'SHINTOMEI' && layer._routeKey === 'shintomei');
                    match ? layer.addTo(map) : map.removeLayer(layer);
                }
            });

            // Fit map to visible markers
            if (filtered.length > 0) {
                const bounds = L.latLngBounds(filtered.map(s => [s.lat, s.lon]));
                map.fitBounds(bounds, { padding: [50, 50], maxZoom: 15 });
            }

            updateAlertList();
        }

        function getLevelConfig() {
            return {
                red: { color: '#ef4444', label: t('levelDanger'), class: 'danger' },
                orange: { color: '#f97316', label: t('levelWarning'), class: 'warning' },
                yellow: { color: '#eab308', label: t('levelCaution'), class: 'caution' },
                green: { color: '#22c55e', label: t('levelSafe'), class: 'safe' },
                unknown: { color: '#9ca3af', label: t('levelUnknown'), class: 'unknown' }
            };
        }

        function getActionText(level) {
            switch(level) {
                case 'red': return t('popupActionDanger');
                case 'orange': return t('popupActionWarning');
                case 'yellow': return t('popupActionCaution');
                case 'unknown': return t('popupActionUnknown');
                default: return t('popupActionSafe');
            }
        }

        function formatSegmentName(segmentId) {
            // Convert segment IDs to readable names
            if (segmentId.startsWith('SHINTOMEI_')) {
                const num = segmentId.replace('SHINTOMEI_', '');
                return currentLang === 'en'
                    ? `Shin-Tomei Slope #${parseInt(num)}`
                    : `æ–°æ±å ã®ã‚Šé¢ #${parseInt(num)}`;
            } else if (segmentId.startsWith('TOMEI_')) {
                const num = segmentId.replace('TOMEI_', '');
                return currentLang === 'en'
                    ? `Tomei Point #${parseInt(num)}`
                    : `æ±å ç›£è¦–ãƒã‚¤ãƒ³ãƒˆ #${parseInt(num)}`;
            }
            return segmentId;
        }

        function parseMessage(message) {
            // Remove source tag for display
            const cleanMessage = message.replace(/\s*\[.*?\]/, '');
            const parts = cleanMessage.split('|').map(p => p.trim());
            const mainStatus = parts[0] || '';

            // Simplify for non-experts
            if (currentLang === 'en') {
                if (cleanMessage.includes('å¤‰å‹•é€Ÿåº¦å¤§') || cleanMessage.includes('å¤‰å‹•ãŒåŠ é€Ÿ') || cleanMessage.includes('é¡•è‘—ãªå¤‰å‹•')) {
                    return 'Significant ground movement detected';
                } else if (cleanMessage.includes('å¤‰å‹•ã‚’æ¤œå‡º') || cleanMessage.includes('å¤‰å‹•ã‚ã‚Š')) {
                    return 'Ground movement detected';
                } else if (cleanMessage.includes('æ€¥å‚¾æ–œ') || cleanMessage.includes('æ€¥æ–œé¢')) {
                    return 'Steep slope area';
                } else if (cleanMessage.includes('å¤§é›¨') || cleanMessage.includes('å¤šé‡ã®é™é›¨')) {
                    return 'Heavy rainfall - attention required';
                } else if (cleanMessage.includes('é™é›¨')) {
                    return 'Recent rainfall recorded';
                } else if (cleanMessage.includes('ç½å®³å±¥æ­´') || cleanMessage.includes('å±¥æ­´ã‚ã‚Š')) {
                    return 'Past disaster history in area';
                } else if (cleanMessage.includes('SARæœªå–å¾—')) {
                    return 'Provisional assessment (no SAR data)';
                } else if (cleanMessage.includes('å®‰å®š') || cleanMessage.includes('ç•°å¸¸ãªã—')) {
                    return 'Conditions stable';
                } else if (cleanMessage.includes('çµŒéè¦³å¯Ÿ')) {
                    return 'Under observation';
                } else if (cleanMessage.includes('è¦æ³¨æ„')) {
                    return 'Attention required';
                } else if (cleanMessage.includes('è¦å¯¾å¿œ') || cleanMessage.includes('ç·Šæ€¥')) {
                    return 'Urgent action required';
                }
                return 'Monitoring in progress';
            } else {
                if (cleanMessage.includes('å¤‰å‹•é€Ÿåº¦å¤§') || cleanMessage.includes('å¤‰å‹•ãŒåŠ é€Ÿ')) {
                    return 'åœ°ç›¤ã®å‹•ããŒæ¤œå‡ºã•ã‚Œã¦ã„ã¾ã™';
                } else if (cleanMessage.includes('æ€¥å‚¾æ–œ')) {
                    return 'å‚¾æ–œãŒæ€¥ãªç®‡æ‰€ã§ã™';
                } else if (cleanMessage.includes('å¤§é›¨')) {
                    return 'é™é›¨ã®å½±éŸ¿ã«æ³¨æ„ãŒå¿…è¦ã§ã™';
                } else if (cleanMessage.includes('SARæœªå–å¾—')) {
                    return 'SARæœªå–å¾—ãƒ»ä»–ãƒ‡ãƒ¼ã‚¿ã§æš«å®šè©•ä¾¡ä¸­';
                } else if (cleanMessage.includes('å®‰å®š') || cleanMessage.includes('ç•°å¸¸ãªã—')) {
                    return 'å®‰å®šã—ãŸçŠ¶æ…‹ã§ã™';
                }
                return mainStatus.replace(/ã€.*?ã€‘/, '').trim() || 'ç›£è¦–ä¸­';
            }
        }

        // Insight translation - exact matches from API
        function translateInsightLabel(label) {
            const map = {
                'è¡›æ˜Ÿè¦³æ¸¬': 'Satellite',
                'åœ°å½¢': 'Terrain',
                'æ°—è±¡': 'Weather',
                'åœ°è³ª': 'Geology',
                'å±¥æ­´': 'History',
                'æ³•é¢æ§‹é€ ': 'Slope Structure',
                'åŒºé–“': 'Section',
                'æ–¹å‘': 'Direction',
                'ã‚­ãƒ­ãƒã‚¹ãƒˆ': 'Kilometer Post'
            };
            return map[label] || label;
        }

        function translateInsightValue(value) {
            const exactMap = {
                // Satellite observation
                'å¤§ããªåœ°ç›¤å¤‰å‹•ã‚’æ¤œå‡º': 'Significant ground movement detected',
                'åœ°ç›¤å¤‰å‹•ã‚’æ¤œå‡º': 'Ground movement detected',
                'åœ°ç›¤ã¯å®‰å®š': 'Ground is stable',
                'è¦³æ¸¬ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­': 'Collecting observation data',
                'SAR ãƒ‡ãƒ¼ã‚¿æœªå–å¾—': 'SAR data unavailable',
                // Norimen structure (slope tiers)
                // Pattern: Nã®æ³•é¢ -> N-tier slope
                // Terrain
                'æ€¥å‚¾æ–œåœ°': 'Steep slope',
                'ã‚„ã‚„æ€¥ãªå‚¾æ–œ': 'Moderately steep slope',
                'ç·©ã‚„ã‹ãªå‚¾æ–œ': 'Gentle slope',
                // Weather
                'å¤§é›¨ã®å½±éŸ¿ã‚ã‚Š': 'Heavy rain impact',
                'é™é›¨ã®å½±éŸ¿ã‚ã‚Š': 'Rainfall impact',
                'ä¹¾ç‡¥çŠ¶æ…‹': 'Dry conditions',
                // Geology
                'èŠ±å´—å²©ï¼ˆå®‰å®šï¼‰': 'Granite (stable)',
                'å®‰å±±å²©ï¼ˆå®‰å®šï¼‰': 'Andesite (stable)',
                'ç„æ­¦å²©ï¼ˆå®‰å®šï¼‰': 'Basite (stable)',
                'ç ‚å²©ï¼ˆã‚„ã‚„æ³¨æ„ï¼‰': 'Sandstone (caution)',
                'æ³¥å²©ï¼ˆè¦æ³¨æ„ï¼‰': 'Mudstone (attention needed)',
                'ç«å±±ç°ï¼ˆè¦æ³¨æ„ï¼‰': 'Volcanic ash (attention needed)',
                'æ²–ç©å±¤ï¼ˆæ™®é€šï¼‰': 'Alluvial (normal)',
                'ä¸Šä¸‹ç·šå…±æœ‰': 'Both directions',
                'ä¸Šã‚Šç·š': 'Upbound',
                'ä¸‹ã‚Šç·š': 'Downbound'
            };

            // Exact match
            if (exactMap[value]) {
                return exactMap[value];
            }

            // Historical events pattern: éå»ã«Nä»¶ã®ç½å®³è¨˜éŒ²
            const historyMatch = value.match(/éå»ã«(\d+)ä»¶ã®ç½å®³è¨˜éŒ²/);
            if (historyMatch) {
                return `${historyMatch[1]} past disaster record(s)`;
            }

            // Norimen tier pattern: Næ®µã®æ³•é¢
            const tierMatch = value.match(/(\d+)æ®µã®æ³•é¢/);
            if (tierMatch) {
                return `${tierMatch[1]}-tier slope`;
            }

            // IC section pattern: ICå â†’ ICå
            if (value.includes('â†’')) {
                return value;  // Keep as-is (IC names)
            }

            return value;
        }

        function translateInsightDetail(detail) {
            if (!detail) return '';

            const exactMap = {
                'æœ‰æ„ãªå¤‰å‹•ãªã—': 'No significant movement',
                'é™é›¨ã®å½±éŸ¿ãªã—': 'No rainfall impact',
                'åœ°è³ªèª¿æŸ»ãƒ‡ãƒ¼ã‚¿ã‚ˆã‚Š': 'From geological survey data',
                'NEXCOç®¡ç†ãƒ‡ãƒ¼ã‚¿ã‚ˆã‚Š': 'From NEXCO management data',
                'åœ°å½¢ãƒ»æ°—è±¡ãƒ»åœ°è³ªãƒ»å±¥æ­´ã«ã‚ˆã‚‹æš«å®šè©•ä¾¡': 'Provisional assessment from terrain, weather, geology & history',
                'InSARãƒ‡ãƒ¼ã‚¿ã‚’åé›†ä¸­ã§ã™': 'Collecting InSAR data'
            };

            if (exactMap[detail]) {
                return exactMap[detail];
            }

            let result = detail;

            // Norimen length pattern: å»¶é•· Nm
            result = result.replace(/å»¶é•·\s*([\d.]+)m/g, 'Length: $1m');

            // Pattern: å¹´é–“ Nmm ã®å‹•ã
            result = result.replace(/å¹´é–“\s*([\d.]+)mm\s*ã®å‹•ã/g, '$1mm movement per year');

            // Pattern: å‚¾æ–œè§’ NÂ°
            result = result.replace(/å‚¾æ–œè§’\s*([\d.]+)Â°/g, 'Slope angle: $1Â°');

            // Pattern: 48æ™‚é–“ã§ Nmm
            result = result.replace(/48æ™‚é–“ã§\s*([\d.]+)mm/g, '$1mm in 48 hours');

            // Pattern: æœ€å¯„ã‚Š N.Nkm
            result = result.replace(/æœ€å¯„ã‚Š\s*([\d.]+)km/g, 'Nearest: $1km');

            return result;
        }

        function fitPopupToMap(popup) {
            if (!popup._container) return;
            const mapH = map.getContainer().clientHeight;
            const maxH = mapH - 100;
            const contentNode = popup._contentNode;
            if (contentNode) {
                contentNode.style.maxHeight = maxH + 'px';
                contentNode.style.overflowY = 'auto';
            }
            popup.update();
        }

        function createMarker(segment) {
            const levelConfig = getLevelConfig();
            const config = levelConfig[segment.level] || levelConfig.unknown;

            const isProvisional = segment.is_reliable === false;
            const borderStyle = isProvisional ? '3px dashed white' : '3px solid white';
            const opacity = isProvisional ? '0.75' : '1';
            const icon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="
                    width: 20px;
                    height: 20px;
                    background: ${config.color};
                    border-radius: 50%;
                    border: ${borderStyle};
                    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                    opacity: ${opacity};
                "></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });

            const simpleMessage = parseMessage(segment.message);

            // Build insights HTML
            let insightsHtml = '';
            if (segment.insights && segment.insights.length > 0) {
                insightsHtml = `
                    <div class="popup-insights">
                        <div class="popup-insights-title">${t('insightsTitle')}</div>
                        ${segment.insights.map(insight => {
                            // Translate insight labels if English
                            const label = currentLang === 'en' ? translateInsightLabel(insight.label) : insight.label;
                            const value = currentLang === 'en' ? translateInsightValue(insight.value) : insight.value;
                            const detail = insight.detail ? (currentLang === 'en' ? translateInsightDetail(insight.detail) : insight.detail) : '';
                            return `
                            <div class="insight-item ${insight.severity}">
                                <div class="insight-icon">${insight.icon}</div>
                                <div class="insight-content">
                                    <div class="insight-label">${label}</div>
                                    <div class="insight-value">${value}</div>
                                    ${detail ? `<div class="insight-detail">${detail}</div>` : ''}
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                `;
            }

            const sid = segment.segment_id;
            const provisionalBadge = segment.is_reliable === false
                ? `<span style="display:inline-block;font-size:10px;background:#fef3c7;color:#92400e;padding:1px 6px;border-radius:4px;margin-left:6px;vertical-align:middle;">${currentLang === 'en' ? 'Provisional' : 'æš«å®š'}</span>`
                : '';

            const popup = `
                <div class="popup-content" data-segment-id="${sid}">
                    <div class="popup-header">
                        <div class="popup-title">${formatSegmentName(sid)}${provisionalBadge}</div>
                        <div class="popup-score ${config.class}">${config.label}</div>
                    </div>
                    <div class="popup-status">
                        <strong>${getActionText(segment.level)}</strong>
                    </div>
                    ${insightsHtml}
                    <div class="popup-details" style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #eee;">
                        <div class="popup-detail-row"><span>${t('coordinates')}</span><span>${segment.lat.toFixed(4)}, ${segment.lon.toFixed(4)}</span></div>
                    </div>
                    <div class="popup-actions-bar">
                        <button class="popup-action-btn" onclick="openInspectionModal('${sid}')">ğŸ“‹ ${t('inspectionBtn')}</button>
                        <button class="popup-action-btn" onclick="toggleChatPanel(); sendSuggestion('${sid}ã®çŠ¶æ³ã‚’æ•™ãˆã¦')">ğŸ’¬ AI</button>
                    </div>
                    <div class="popup-inspections-section">
                        <div class="popup-inspections-title">ğŸ“‹ ${t('inspectionHistory')}</div>
                        <div id="inspections-${sid}" class="popup-inspections-list"><span style="font-size:11px;color:#999;">${t('noInspections')}</span></div>
                    </div>
                </div>
            `;

            const marker = L.marker([segment.lat, segment.lon], { icon }).bindPopup(popup, {
                autoClose: true,
                closeOnClick: false,
                maxWidth: 350,
                autoPan: true,
                autoPanPadding: [40, 40]
            });
            marker.on('popupopen', function(e) {
                fitPopupToMap(e.popup);
                loadInspections(sid).then(() => fitPopupToMap(e.popup));
            });
            marker._segmentId = sid;
            return marker;
        }

        function filterByLevel(level) {
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            const filtered = level ? allSegments.filter(s => s.level === level) : allSegments;
            filtered.forEach(segment => {
                const marker = createMarker(segment);
                marker.addTo(map);
                markers.push(marker);
            });

            if (filtered.length > 0) {
                const bounds = L.latLngBounds(filtered.map(s => [s.lat, s.lon]));
                map.fitBounds(bounds, { padding: [50, 50], maxZoom: 15 });
            }
        }

        async function fetchData() {
            try {
                const [segmentsRes, statsRes] = await Promise.all([
                    fetch('/api/v1/segments'),
                    fetch('/api/v1/stats')
                ]);

                const segments = await segmentsRes.json();
                const stats = await statsRes.json();
                allSegments = segments;

                // Update counts
                document.getElementById('count-danger').textContent = stats.segments_by_level?.red || 0;
                document.getElementById('count-warning').textContent = stats.segments_by_level?.orange || 0;
                document.getElementById('count-caution').textContent = stats.segments_by_level?.yellow || 0;
                document.getElementById('count-safe').textContent = stats.segments_by_level?.green || 0;

                // Clear and add markers
                markers.forEach(m => map.removeLayer(m));
                markers = [];
                segments.forEach(segment => {
                    const marker = createMarker(segment);
                    marker.addTo(map);
                    markers.push(marker);
                });

                // Update alerts
                updateAlertList();

                // Fetch and draw expressway routes (once)
                if (routeLayers.length === 0) {
                    try {
                        const routesRes = await fetch('/api/v1/routes');
                        const routes = await routesRes.json();

                        const routeStyles = {
                            tomei:     { color: '#3b82f6', label: 'æ±å (E1)',  labelEn: 'Tomei (E1)' },
                            shintomei: { color: '#8b5cf6', label: 'æ–°æ±å (E1A)', labelEn: 'Shin-Tomei (E1A)' }
                        };

                        for (const [key, route] of Object.entries(routes)) {
                            const style = routeStyles[key] || { color: '#6b7280', label: key, labelEn: key };
                            const line = L.polyline(route.coordinates, {
                                color: style.color,
                                weight: 3,
                                opacity: 0.8
                            }).addTo(map);
                            line._routeKey = key;
                            line._style = style;
                            routeLayers.push(line);
                        }
                    } catch (e) {
                        console.warn('Could not load routes:', e);
                    }
                }

                document.getElementById('update-time').textContent =
                    t('lastUpdate') + ': ' + new Date().toLocaleString(currentLang === 'ja' ? 'ja-JP' : 'en-US');

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('alert-list').innerHTML = `
                    <div class="no-alerts">
                        <div class="no-alerts-icon">âš ï¸</div>
                        <div class="no-alerts-text">${t('loadError')}</div>
                    </div>
                `;
            }
        }

        function updateAlertList() {
            let filtered = allSegments;
            if (currentRouteFilter !== 'all') {
                filtered = filtered.filter(s => s.segment_id.startsWith(currentRouteFilter));
            }
            const alerts = filtered
                .filter(s => ['red', 'orange', 'yellow'].includes(s.level))
                .sort((a, b) => b.score - a.score);

            document.getElementById('alert-count').textContent = alerts.length;

            const alertList = document.getElementById('alert-list');
            const levelConfig = getLevelConfig();

            if (alerts.length === 0) {
                alertList.innerHTML = `
                    <div class="no-alerts">
                        <div class="no-alerts-icon">âœ…</div>
                        <div class="no-alerts-text">${t('noAlerts')}</div>
                    </div>
                `;
            } else {
                alertList.innerHTML = alerts.map(alert => {
                    const config = levelConfig[alert.level];
                    const simpleMessage = parseMessage(alert.message);
                    return `
                        <div class="alert-item ${config.class}" onclick="map.setView([${alert.lat}, ${alert.lon}], 17); setTimeout(() => markers.find(m => m.getLatLng().lat.toFixed(4) === '${alert.lat.toFixed(4)}')?.openPopup(), 300);">
                            <div class="alert-top">
                                <div class="alert-location">ğŸ“ ${formatSegmentName(alert.segment_id)}</div>
                                <div class="alert-badge">${config.label}</div>
                            </div>
                            <div class="alert-status">${simpleMessage}</div>
                            <div class="alert-action">
                                <span class="alert-action-icon">â†’</span>
                                ${t('clickToView')}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // ============================================
        // Chat Panel
        // ============================================
        let chatSessionId = null;
        let chatOpen = false;
        let chatBusy = false;
        let chatModel = 'fast';

        function setChatModel(model) {
            chatModel = model;
            document.querySelectorAll('.chat-model-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.model === model);
            });
        }

        function toggleChatPanel() {
            chatOpen = !chatOpen;
            document.getElementById('chat-panel').classList.toggle('open', chatOpen);
            document.getElementById('agent-toggle').classList.toggle('active', chatOpen);
            if (chatOpen) {
                setTimeout(() => document.getElementById('chat-input').focus(), 350);
            }
        }

        function setChatBusy(busy) {
            chatBusy = busy;
            const input = document.getElementById('chat-input');
            const sendBtn = document.getElementById('chat-send');
            const suggestBtns = document.querySelectorAll('.chat-suggest-btn');
            input.disabled = busy;
            sendBtn.disabled = busy;
            suggestBtns.forEach(b => { b.disabled = busy; b.style.opacity = busy ? '0.5' : '1'; b.style.pointerEvents = busy ? 'none' : 'auto'; });
            if (!busy) input.focus();
        }

        function sendSuggestion(text) {
            if (chatBusy) return;
            document.getElementById('chat-input').value = text;
            sendChatMessage();
        }

        async function sendChatMessage() {
            if (chatBusy) return;
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;
            input.value = '';
            autoResizeInput();

            // Hide suggestions
            const suggest = document.getElementById('chat-suggest');
            if (suggest) suggest.style.display = 'none';

            // Lock UI
            setChatBusy(true);

            // Show user message
            appendChatMsg('user', msg);

            // Show animated typing indicator
            const thinkingId = appendChatMsg('thinking', '');

            try {
                const res = await fetch('/api/v1/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg, session_id: chatSessionId, model: chatModel })
                });
                if (!res.ok) {
                    const errText = await res.text();
                    throw new Error(`${res.status}: ${errText.slice(0, 100)}`);
                }
                const data = await res.json();
                chatSessionId = data.session_id;

                // Remove thinking, show reply
                removeChatMsg(thinkingId);
                appendChatMsg('assistant', data.reply, data.segment_ids);
            } catch (e) {
                removeChatMsg(thinkingId);
                appendChatMsg('assistant', 'Error: ' + e.message);
            }

            // Unlock UI
            setChatBusy(false);
        }

        let chatMsgCounter = 0;
        function appendChatMsg(role, text, segmentIds) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            const id = 'chat-msg-' + (++chatMsgCounter);
            div.id = id;
            div.className = `chat-msg ${role} appear`;

            if (role === 'thinking') {
                div.innerHTML = `<div class="chat-typing-dots"><span></span><span></span><span></span></div>`;
            } else if (role === 'assistant') {
                div.innerHTML = formatChatResponse(text);
            } else {
                div.textContent = text;
            }

            container.appendChild(div);
            // Smooth scroll to bottom
            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
            return id;
        }

        function removeChatMsg(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function formatChatResponse(text) {
            // Markdown links [title](url)
            let html = text.replace(/\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g,
                '<a href="$2" target="_blank" rel="noopener" style="color:#2563eb;text-decoration:underline;">$1</a>');
            // Markdown-style bold
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Markdown lists
            html = html.replace(/^\*\s+/gm, '&bull; ');
            // Segment IDs â†’ clickable links
            html = html.replace(/((?:SHINTOMEI|TOMEI)_\d{4})/g,
                '<span class="seg-link" onclick="focusSegment(\'$1\')">$1</span>');
            html = html.replace(/\n/g, '<br>');
            return html;
        }

        function focusSegment(segmentId) {
            const seg = allSegments.find(s => s.segment_id === segmentId);
            if (seg) {
                const targetZoom = Math.max(map.getZoom(), 15);
                map.setView([seg.lat, seg.lon], targetZoom, { animate: true });
                setTimeout(() => {
                    const m = markers.find(mk => mk._segmentId === segmentId);
                    if (m) m.openPopup();
                }, 400);
            }
        }

        // Auto-resize textarea
        function autoResizeInput() {
            const el = document.getElementById('chat-input');
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 100) + 'px';
        }
        document.addEventListener('DOMContentLoaded', () => {
            const chatInput = document.getElementById('chat-input');
            chatInput.addEventListener('input', autoResizeInput);
        });

        // ============================================
        // Popup Inspection History
        // ============================================
        function getConditionLabel(condition) {
            const map = { good: 'conditionGood', fair: 'conditionFair', poor: 'conditionPoor', critical: 'conditionCritical' };
            return t(map[condition] || condition);
        }

        async function loadInspections(segmentId) {
            try {
                const res = await fetch(`/api/v1/inspections?segment_id=${segmentId}`);
                const inspections = await res.json();
                const container = document.getElementById(`inspections-${segmentId}`);
                if (!container) return;
                if (inspections.length === 0) {
                    container.innerHTML = `<span style="font-size:11px;color:#999;">${t('noInspections')}</span>`;
                } else {
                    container.innerHTML = inspections.map(ins => `
                        <div class="popup-inspection-item cond-${ins.condition}">
                            <div class="popup-inspection-meta">
                                ${ins.date} | ${ins.inspector || 'N/A'} | ${ins.weather || ''}
                                <span class="popup-inspection-badge ${ins.condition}">${getConditionLabel(ins.condition)}</span>
                            </div>
                            ${ins.findings ? `<div class="popup-inspection-findings">${ins.findings}</div>` : ''}
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.warn('Failed to load inspections:', e);
            }
        }

        // ============================================
        // Inspection Modal
        // ============================================
        function openInspectionModal(segmentId) {
            document.getElementById('inspection-segment-id').value = segmentId;
            document.getElementById('inspection-date').value = new Date().toISOString().slice(0, 10);
            document.getElementById('inspection-inspector').value = '';
            document.getElementById('inspection-weather').value = '';
            document.getElementById('inspection-condition').value = 'good';
            document.getElementById('inspection-findings').value = '';
            document.getElementById('inspection-modal').classList.add('open');

            // Update modal labels for current language
            document.getElementById('modal-inspection-title').textContent = t('inspectionTitle');
            document.getElementById('label-inspector').textContent = t('inspectorLabel');
            document.getElementById('label-date').textContent = t('dateLabel');
            document.getElementById('label-weather').textContent = t('weatherLabel');
            document.getElementById('label-condition').textContent = t('conditionLabel');
            document.getElementById('label-findings').textContent = t('findingsLabel');
            document.getElementById('btn-cancel').textContent = t('cancelBtn');
            document.getElementById('btn-submit-inspection').textContent = t('submitBtn');
        }

        function closeInspectionModal() {
            document.getElementById('inspection-modal').classList.remove('open');
        }

        async function submitInspection() {
            const segmentId = document.getElementById('inspection-segment-id').value;
            const body = {
                segment_id: segmentId,
                inspector: document.getElementById('inspection-inspector').value,
                date: document.getElementById('inspection-date').value,
                weather: document.getElementById('inspection-weather').value,
                condition: document.getElementById('inspection-condition').value,
                findings: document.getElementById('inspection-findings').value,
            };

            try {
                await fetch('/api/v1/inspections', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                closeInspectionModal();
                loadInspections(segmentId);
                loadAllInspections();
            } catch (e) {
                console.warn('Failed to submit inspection:', e);
            }
        }

        // ============================================
        // Sidebar Tab Switching & All Inspections
        // ============================================
        function switchSidebarTab(tab) {
            document.getElementById('tab-alerts').style.display = tab === 'alerts' ? '' : 'none';
            document.getElementById('tab-inspections').style.display = tab === 'inspections' ? '' : 'none';
            document.getElementById('sidebar-tab-alerts').classList.toggle('active', tab === 'alerts');
            document.getElementById('sidebar-tab-inspections').classList.toggle('active', tab === 'inspections');
            if (tab === 'inspections') {
                loadAllInspections();
            }
        }

        async function loadAllInspections() {
            try {
                const res = await fetch('/api/v1/inspections/all?limit=50');
                const inspections = await res.json();
                const container = document.getElementById('sidebar-inspection-list');
                if (inspections.length === 0) {
                    container.innerHTML = `<div style="text-align:center;color:#999;padding:20px;font-size:13px;">${t('noInspections')}</div>`;
                    return;
                }
                container.innerHTML = inspections.map(ins => {
                    const seg = allSegments.find(s => s.segment_id === ins.segment_id);
                    const clickHandler = seg
                        ? `map.setView([${seg.lat}, ${seg.lon}], 17); setTimeout(() => markers.find(m => m.getLatLng().lat.toFixed(4) === '${seg.lat.toFixed(4)}')?.openPopup(), 300);`
                        : '';
                    return `
                        <div class="sidebar-inspection-item cond-${ins.condition}" ${clickHandler ? `onclick="${clickHandler}"` : ''}>
                            <div class="sidebar-inspection-top">
                                <div class="sidebar-inspection-location">ğŸ“ ${formatSegmentName(ins.segment_id)}</div>
                                <span class="sidebar-inspection-badge ${ins.condition}">${getConditionLabel(ins.condition)}</span>
                            </div>
                            <div class="sidebar-inspection-meta">${ins.date} | ${ins.inspector || 'N/A'} | ${ins.weather || ''}</div>
                            ${ins.findings ? `<div class="sidebar-inspection-findings">${ins.findings}</div>` : ''}
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.warn('Failed to load all inspections:', e);
            }
        }

        // ============================================
        // Chat panel language updates
        // ============================================
        function updateChatLanguage() {
            document.getElementById('chat-title').textContent = t('chatTitle');
            document.getElementById('chat-input').placeholder = t('chatPlaceholder');
            document.getElementById('chat-send').textContent = t('chatSend');
            const suggestLabel = document.getElementById('chat-suggest-label');
            if (suggestLabel) suggestLabel.textContent = t('chatSuggestLabel');
        }

        // Patch updateUILanguage to also update chat + sidebar tabs
        const _origUpdateUILanguage = updateUILanguage;
        updateUILanguage = function() {
            _origUpdateUILanguage();
            updateChatLanguage();
            document.getElementById('sidebar-tab-alerts').textContent = 'âš ï¸ ' + t('alertsTab');
            document.getElementById('sidebar-tab-inspections').textContent = 'ğŸ“‹ ' + t('inspectionTab');
        };

        // Initial fetch
        fetchData();

        // Apply initial language on load
        updateUILanguage();

        // Auto-refresh every 60 seconds
        setInterval(fetchData, 60000);
    </script>
</body>
</html>
